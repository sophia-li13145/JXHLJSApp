<ContentPage
    x:Class="JXHLJSApp.Pages.WarehouseLocationPickerPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:JXHLJSApp.ViewModels"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    Title="é€‰æ‹©åº“ä½"
    BackgroundColor="White"
    Padding="12">

    <!-- ä¸‰è¡Œæ …æ ¼ï¼š1) æ‰«ç è¾“å…¥ 2) å›¾ä¾‹ 3) åˆ—è¡¨ -->
    <Grid RowDefinitions="Auto,Auto,*" RowSpacing="8">

        <!-- 1) é¡¶éƒ¨ï¼šè¾“å…¥æ¡ç  + æ‰«ææŒ‰é’® -->
        <Grid ColumnDefinitions="*,48" RowDefinitions="Auto" ColumnSpacing="8">
            <Entry Placeholder="è¯·æ‰«æ/è¾“å…¥åº“ä½æ¡ç "
                   Text="{Binding ScanText}"
                   ClearButtonVisibility="WhileEditing" />
            <Button Grid.Column="1"
                    Text="ðŸ”"
                    Command="{Binding ScanSubmitCommand}" />
        </Grid>

        <!-- 2) å›¾ä¾‹ -->
        <Grid Grid.Row="1"
              ColumnDefinitions="Auto,Auto,Auto,Auto"
              ColumnSpacing="12"
              VerticalOptions="Center">
            <BoxView Grid.Column="0"
                     WidthRequest="16"
                     HeightRequest="16"
                     VerticalOptions="Center"
                     Color="#2ecc71"/>
            <Label   Grid.Column="1"
                     Text="ç©ºåº“ä½"
                     VerticalOptions="Center" />

            <BoxView Grid.Column="2"
                     WidthRequest="16"
                     HeightRequest="16"
                     VerticalOptions="Center"
                     Color="#f39c12"/>
            <Label   Grid.Column="3"
                     Text="å·²è£…è´§"
                     VerticalOptions="Center" />
        </Grid>

        <!-- 3) ä»“åº“ + åº“ä½åˆ—è¡¨ï¼ˆExpanderï¼‰ -->
        <CollectionView x:Name="PickerRoot"
                        Grid.Row="2"
                        ItemsSource="{Binding Warehouses}"
                        SelectionMode="None">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:WarehouseVM">
                    <VerticalStackLayout Spacing="0">

                        <!-- æ³¨æ„ï¼šè®© Expander è‡ªå¸¦çš„ Header ç‚¹å‡»æ¥æŽ§åˆ¶å±•å¼€/æ”¶èµ·ï¼›
                             ä¸å†é¢å¤–åŠ  Tap æ‰‹åŠ¿ï¼Œé¿å…â€œä¸€æ¬¡ç‚¹å‡»åˆ‡ä¸¤æ¬¡â€çš„é—®é¢˜ -->
                        <toolkit:Expander IsExpanded="{Binding IsExpanded, Mode=TwoWay}">
                            <toolkit:Expander.Header>
                                <Grid Padding="12,10" BackgroundColor="Transparent">
                                    <Label Text="{Binding Title}" FontAttributes="Bold" />
                                </Grid>
                            </toolkit:Expander.Header>

                            <toolkit:Expander.Content>
                                <!-- å¤–å±‚ï¼šæŒ‰ç»„å±•ç¤ºï¼ˆæ¯ä¸ª layerData çš„ List = ä¸€ç»„ï¼‰ -->
                                <FlexLayout Direction="Column"
                BindableLayout.ItemsSource="{Binding Groups}"
                AlignItems="Stretch"
                JustifyContent="Start">

                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="vm:LocationGroupVM">
                                            <VerticalStackLayout Spacing="0">

                                                <!-- ç»„é—´â€œè™šçº¿åˆ†éš”â€ï¼šç¬¬ä¸€ç»„ä¸æ˜¾ç¤º -->
                                                <Border HeightRequest="1"
                            Margin="0,8,0,8"
                            HorizontalOptions="Fill"
                            Stroke="Gray"
                            StrokeThickness="1"
                            StrokeDashArray="6,4"
                            Opacity="0.5">
                                                    <Border.Triggers>
                                                        <DataTrigger TargetType="Border" Binding="{Binding IsFirst}" Value="True">
                                                            <Setter Property="IsVisible" Value="False" />
                                                        </DataTrigger>
                                                    </Border.Triggers>
                                                </Border>

                                                <!-- ç»„å†…ï¼šæ²¿ç”¨ä½ åŽŸæ¥çš„æŒ‰é’®æ ·å¼ï¼ˆæ¨ªå‘æ¢è¡Œï¼‰ -->
                                                <FlexLayout Direction="Row"
                                Wrap="Wrap"
                                BindableLayout.ItemsSource="{Binding .}">
                                                    <BindableLayout.ItemTemplate>
                                                        <DataTemplate x:DataType="vm:LocationVM">
                                                            <Button Text="{Binding DisplayText}"
                                        Padding="10,6"
                                        Margin="4"
                                        TextColor="White"
                                        Command="{Binding BindingContext.SelectLocationCommand,
                                                          Source={x:Reference PickerRoot}}"
                                        CommandParameter="{Binding}">
                                                                <Button.Style>
                                                                    <Style TargetType="Button">
                                                                        <!-- é»˜è®¤ç©ºåº“ä½ï¼šç»¿è‰² -->
                                                                        <Setter Property="BackgroundColor" Value="#2ecc71" />
                                                                        <Style.Triggers>
                                                                            <!-- instockï¼šæ©™è‰² -->
                                                                            <DataTrigger TargetType="Button"
                                                             Binding="{Binding InventoryStatus}"
                                                             Value="instock">
                                                                                <Setter Property="BackgroundColor" Value="#f39c12" />
                                                                            </DataTrigger>
                                                                            <!-- æ‰«ç å‘½ä¸­ï¼šè“è‰² -->
                                                                            <DataTrigger TargetType="Button"
                                                             Binding="{Binding IsHighlighted}"
                                                             Value="True">
                                                                                <Setter Property="BackgroundColor" Value="#3498db" />
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Button.Style>
                                                            </Button>
                                                        </DataTemplate>
                                                    </BindableLayout.ItemTemplate>
                                                </FlexLayout>

                                            </VerticalStackLayout>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>

                                    <!-- ç©ºæ€ï¼šå½“ Groups ä¸ºç©ºæ—¶æ˜¾ç¤º -->
                                    <BindableLayout.EmptyView>
                                        <StackLayout Padding="12"
                         Spacing="6"
                         HorizontalOptions="Center"
                         VerticalOptions="Center">
                                            <Label Text="è¯¥ä»“åº“æš‚æ— åº“ä½" TextColor="#999" />
                                            <Label Text="{Binding Title}"
                       FontSize="12"
                       TextColor="#bbb"
                       HorizontalTextAlignment="Center" />
                                        </StackLayout>
                                    </BindableLayout.EmptyView>

                                </FlexLayout>
                            </toolkit:Expander.Content>

                        </toolkit:Expander>

                        <BoxView HeightRequest="1" BackgroundColor="#eee"/>
                    </VerticalStackLayout>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

    </Grid>
</ContentPage>
