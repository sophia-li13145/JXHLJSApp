<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:JXHLJSApp.ViewModels"
             x:Class="JXHLJSApp.Pages.OutboundMoldPage"
             BackgroundColor="White"
             Shell.NavBarIsVisible="True">
    <ContentPage.BindingContext>
        <vm:OutboundMoldViewModel />
    </ContentPage.BindingContext>

    <!-- 根：4行 = 顶部栏(不滚) + 扫码条(不滚) + 主体滚动 + 底部按钮(不滚) -->
    <Grid RowDefinitions="Auto,Auto,*,Auto">

        <!-- Row 0：标题栏（不滚动） -->
        <Grid Grid.Row="0" BackgroundColor="#007BFF" HeightRequest="60" Padding="16,0">
            <Label Text="仓储管理系统"
                   VerticalOptions="Center"
                   TextColor="White"
                   FontSize="18"
                   FontAttributes="Bold"/>
        </Grid>

        <!-- Row 1：扫码输入（不滚动） -->
        <Grid Grid.Row="1" ColumnDefinitions="*,40" Padding="16,8">
            <Entry x:Name="ScanEntry"
                   Placeholder="请扫描或输入模具编码"
                   FontSize="14"
                   VerticalOptions="Center"
                   BackgroundColor="White"
                   HeightRequest="40"
                   Text="{Binding ScanCode}"
                   ReturnType="Done"
                   Completed="ScanEntry_Completed" />
            <ImageButton Grid.Column="1"
            Source="scan_button.png"      
            WidthRequest="36"
             HeightRequest="36"
             BackgroundColor="Transparent"
             Padding="0"
             Aspect="AspectFit"
             Clicked="OnScanClicked"  />
        </Grid>

        <!-- Row 2：主体可滚动区域 -->
        <ScrollView Grid.Row="2" x:Name="BodyScroll">
            <VerticalStackLayout Spacing="8" Padding="0" HorizontalOptions="Fill">

                <!-- 基础信息：工单号 / 产品名称 -->
                <Frame Padding="10" BackgroundColor="White" BorderColor="#CCCCCC"
                       HorizontalOptions="Fill"
                       WidthRequest="{Binding Source={x:Reference BodyScroll}, Path=Width}">
                    <Grid ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="12" HorizontalOptions="Fill">
                        <Label Text="工单号：" FontAttributes="Bold" />
                        <Label Grid.Column="1" Text="{Binding WorkOrderNo}" />
                        <Label Grid.Column="2" Text="产品名称：" FontAttributes="Bold" />
                        <Label Grid.Column="3" Text="{Binding MaterialName}" />
                    </Grid>
                </Frame>

                <!-- 分组表：一级=模具型号+数量；二级=模具编码列表 -->
                <Frame Padding="0" BackgroundColor="#F4F7FF" BorderColor="#CCCCCC"
                       HorizontalOptions="Fill"
                       WidthRequest="{Binding Source={x:Reference BodyScroll}, Path=Width}">
                    <Grid RowDefinitions="Auto,Auto" Padding="8" RowSpacing="1" HorizontalOptions="Fill">

                        <!-- 表头 -->
                        <Grid Grid.Row="0" BackgroundColor="#E6EEF9" Padding="8" ColumnSpacing="1" HorizontalOptions="Fill">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="70"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="120"/>
                            </Grid.ColumnDefinitions>
                            <Label Grid.Column="0" Text="序号" HorizontalTextAlignment="Center" FontAttributes="Bold"/>
                            <Label Grid.Column="1" Text="模具型号" FontAttributes="Bold"/>
                            <Label Grid.Column="2" Text="基础需求数量" HorizontalTextAlignment="Center" FontAttributes="Bold"/>
                        </Grid>

                        <!-- 分组列表 -->
                        <CollectionView Grid.Row="1"
                                        ItemsSource="{Binding MoldGroups}"
                                        SelectionMode="None"
                                        HorizontalOptions="Fill">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="vm:MoldGroupVM">
                                    <VerticalStackLayout Spacing="0" HorizontalOptions="Fill">

                                        <!-- 组头（型号行） -->
                                        <Grid BackgroundColor="White" Padding="8" ColumnSpacing="1" HorizontalOptions="Fill">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="70"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="120"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- 属性元素放前/后，避免 XLS0505 -->
                                            <Grid.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding ToggleCommand}" />
                                            </Grid.GestureRecognizers>

                                            <Button Grid.Column="0"
                                                    Text="{Binding ToggleIndicator}" 
                                                    Command="{Binding ToggleCommand}"
                                                    BackgroundColor="Transparent"
                                                    BorderColor="#DDDDDD"
                                                    BorderWidth="1"
                                                    CornerRadius="4"
                                                    TextColor="Black"    
                                                    HorizontalOptions="Center"
                                                    WidthRequest="46"
                                                    HeightRequest="32"/>

                                            <Label Grid.Column="1" Text="{Binding ModelCode}" VerticalTextAlignment="Center"/>
                                            <Label Grid.Column="2" Text="{Binding BaseQty}" HorizontalTextAlignment="Center" VerticalTextAlignment="Center"/>
                                        </Grid>

                                        <BoxView HeightRequest="1" Color="#E6E6E6"/>

                                        <!-- 子表：展开时显示 -->
                                        <Grid Padding="8,0" IsVisible="{Binding IsExpanded}" HorizontalOptions="Fill">
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <Grid Grid.Row="0" BackgroundColor="#E6EEF9" Padding="8" ColumnSpacing="1" HorizontalOptions="Fill">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="70"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <Label Grid.Column="0" Text="序号" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                                                <Label Grid.Column="1" Text="磨具编号" FontAttributes="Bold"/>
                                            </Grid>

                                            <CollectionView Grid.Row="1"
                                                            ItemsSource="{Binding Items}"
                                                            SelectionMode="None"
                                                            HorizontalOptions="Fill">
                                                <CollectionView.ItemTemplate>
                                                    <DataTemplate x:DataType="vm:MoldItemVM">
                                                        <Grid BackgroundColor="White" Padding="8" ColumnSpacing="1" HorizontalOptions="Fill">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="70"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Label Grid.Column="0" Text="{Binding Index}" HorizontalTextAlignment="Center" VerticalTextAlignment="Center"/>
                                                            <Label Grid.Column="1" Text="{Binding MoldNumber}" VerticalTextAlignment="Center"/>
                                                        </Grid>
                                                    </DataTemplate>
                                                </CollectionView.ItemTemplate>
                                            </CollectionView>
                                        </Grid>

                                        <BoxView HeightRequest="1" Color="#CCCCCC"/>
                                    </VerticalStackLayout>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Grid>
                </Frame>

                <!-- 扫描明细：放滚动区里 -->
                <Grid RowDefinitions="Auto,Auto,Auto" Margin="0"
                      HorizontalOptions="Fill"
                      WidthRequest="{Binding Source={x:Reference BodyScroll}, Path=Width}">

                    <Grid ColumnDefinitions="*" BackgroundColor="White">
                        <Button Text="扫描明细"
                                Command="{Binding ShowScannedCommand}"
                                BackgroundColor="{Binding ScannedTabColor}"
                                TextColor="{Binding ScannedTextColor}" />
                    </Grid>

                    <Grid Grid.Row="1"
                          ColumnDefinitions="80,*,*,60,60"
                          BackgroundColor="#F2F2F2"
                          IsVisible="{Binding IsScannedVisible}"
                          Padding="8">
                        <Label Text="选择" FontAttributes="Bold"/>
                        <Label Grid.Column="1" Text="模具编码" FontAttributes="Bold"/>
                        <Label Grid.Column="2" Text="模具型号" FontAttributes="Bold"/>
                        <Label Grid.Column="3" Text="出库数量" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                        <Label Grid.Column="4" Text="出库库位" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                    </Grid>

                    <CollectionView Grid.Row="2"
                                    ItemsSource="{Binding ScannedList}"
                                    IsVisible="{Binding IsScannedVisible}"
                                    SelectionMode="Single"
                                    SelectedItem="{Binding SelectedScanItem, Mode=TwoWay}"
                                    HorizontalOptions="Fill">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="vm:ScannedRow">
                                <Grid ColumnDefinitions="80,*,*,60,60" Padding="8" BackgroundColor="White">
                                    <VisualStateManager.VisualStateGroups>
                                        <VisualStateGroup Name="CommonStates">
                                            <VisualState Name="Normal">
                                                <VisualState.Setters>
                                                    <Setter Property="BackgroundColor" Value="White"/>
                                                </VisualState.Setters>
                                            </VisualState>
                                            <VisualState Name="Selected">
                                                <VisualState.Setters>
                                                    <Setter Property="BackgroundColor" Value="#CCFFCC"/>
                                                </VisualState.Setters>
                                            </VisualState>
                                        </VisualStateGroup>
                                    </VisualStateManager.VisualStateGroups>

                                    <HorizontalStackLayout Spacing="6">
                                        <CheckBox IsChecked="{Binding IsSelected}" VerticalOptions="Center"/>
                                        <Label Text="{Binding Index}" VerticalTextAlignment="Center"/>
                                    </HorizontalStackLayout>

                                    <Label Grid.Column="1" Text="{Binding MoldCode}" />
                                    <Label Grid.Column="2" Text="{Binding MoldModel}" />
                                    <Label Grid.Column="3" Text="{Binding OutQty}" HorizontalTextAlignment="Center"/>
                                    <Label Grid.Column="4" Text="{Binding Location}" HorizontalTextAlignment="Center"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>

            </VerticalStackLayout>
        </ScrollView>

        <!-- Row 3：底部固定操作栏（不滚动） -->
        <Grid Grid.Row="3" ColumnDefinitions="*,*" Padding="16,8" ColumnSpacing="10">

            <Grid Grid.Column="0" BackgroundColor="#F44336" HeightRequest="50">
                <Grid.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding CancelScanCommand}" />
                </Grid.GestureRecognizers>
                <StackLayout Orientation="Horizontal" HorizontalOptions="Center" VerticalOptions="Center">
                    <Image Source="cancel.png" HeightRequest="20" WidthRequest="20" />
                    <Label Text="取消扫描" Margin="5,0,0,0" VerticalOptions="Center" TextColor="White" />
                </StackLayout>
            </Grid>

            <Grid Grid.Column="1" BackgroundColor="#2196F3" HeightRequest="50">
                <Grid.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding ConfirmCommand}" />
                </Grid.GestureRecognizers>
                <StackLayout Orientation="Horizontal" HorizontalOptions="Center" VerticalOptions="Center">
                    <Image Source="confirm.png" HeightRequest="20" WidthRequest="20" />
                    <Label Text="确认出库" Margin="5,0,0,0" VerticalOptions="Center" TextColor="White" />
                </StackLayout>
            </Grid>

        </Grid>
    </Grid>
</ContentPage>