<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Name="ThisPage"
    x:Class="JXHLJSApp.Pages.RepairRunDetailPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:conv="clr-namespace:JXHLJSApp.Converters"
    BackgroundColor="White"
    Title="设备管理系统">

    <!-- 局部样式：按钮/标题/分组标题 -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:NullOrEmptyToBoolInverseConverter x:Key="NullOrEmptyToBoolInverseConverter" />
            <conv:StringToNullableDecimalConverter x:Key="DecConv" />
            <conv:DecParseOnlyConverter x:Key="DecParseOnlyConv" />
            <conv:DefectLevelToColorConverter x:Key="DefectLevelToColor"/>
            <conv:IntGreaterThanZeroConverter x:Key="IntGT0" />
            <conv:IndexConverter x:Key="IndexConverter" />
            <conv:BoolToPrimaryOrGrayConverter x:Key="BoolToPrimaryOrGray" />
            <conv:ActiveToTitleColorConverter  x:Key="ActiveToTitleColor"  />
            <conv:InspectResultToColorConverter x:Key="InspectResultToColorConverter" />
            <Style x:Key="PrimaryBtn" TargetType="Button">
                <Setter Property="HeightRequest" Value="36" />
                <Setter Property="CornerRadius" Value="8" />
                <Setter Property="Padding" Value="18,6" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="BackgroundColor" Value="#2F80ED" />
                <Setter Property="FontAttributes" Value="Bold" />
            </Style>
            <Style x:Key="SuccessBtn" TargetType="Button" BasedOn="{StaticResource PrimaryBtn}">
                <Setter Property="BackgroundColor" Value="#27AE60" />
            </Style>
            <Style x:Key="SectionTitle" TargetType="Label">
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="#1F2937" />
                <Setter Property="Margin" Value="0,5,0,4" />
            </Style>
            <Style x:Key="FieldLabel" TargetType="Label">
                <Setter Property="TextColor" Value="#4B5563" />
                <Setter Property="VerticalTextAlignment" Value="Center" />
                <Setter Property="HorizontalOptions" Value="Start" />
                <Setter Property="HorizontalTextAlignment" Value="Start" />
                <Setter Property="Padding" Value="0" />
            </Style>
            <Style x:Key="FieldValue" TargetType="Label">
                <Setter Property="TextColor" Value="#111827" />
                <Setter Property="VerticalTextAlignment" Value="Center" />
                <Setter Property="HorizontalOptions" Value="Start" />
                <Setter Property="HorizontalTextAlignment" Value="Start" />
            </Style>
            <Style x:Key="Card" TargetType="Frame">
                <Setter Property="Padding" Value="12" />
                <Setter Property="CornerRadius" Value="8" />
                <Setter Property="HasShadow" Value="False" />
                <Setter Property="BorderColor" Value="#E5E7EB" />
            </Style>
            <!-- 只读展示小灰框 -->
            <Style x:Key="ReadonlyPill" TargetType="Frame">
                <Setter Property="Padding" Value="8,6" />
                <Setter Property="CornerRadius" Value="6" />
                <Setter Property="HasShadow" Value="False" />
                <Setter Property="BackgroundColor" Value="#F3F4F6" />
                <Setter Property="BorderColor" Value="#E5E7EB" />
            </Style>
            <Style TargetType="Entry">
                <Setter Property="HorizontalOptions" Value="Fill" />
                <Setter Property="Margin" Value="0" />
                <Setter Property="HeightRequest" Value="42" />
                <Setter Property="VerticalOptions" Value="Center" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="HorizontalTextAlignment" Value="Start" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid x:Name="RootGrid">

        <!-- 点击空白处收起检验员下拉 -->
        <Grid.GestureRecognizers>
            <TapGestureRecognizer Command="{Binding ClearUpkeepOperatorCommand}" />
        </Grid.GestureRecognizers>

        <ScrollView>
            <VerticalStackLayout Spacing="8" Padding="12">

                <Grid Grid.Row="0"  HeightRequest="56" Padding="12" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                    <Label Text="维修工单基础信息"
                             VerticalOptions="Start"
                             TextColor="Black"
                             FontSize="14"
                             FontAttributes="Bold" />
                                                <Button Grid.Column="1"
                              Text="保存"
                              Style="{StaticResource PrimaryBtn}"
                              Command="{Binding SaveCommand}"
                              IsVisible="{Binding IsEditing}"/>
                                                <Button Grid.Column="2"
                              Text="完成维修"
                              Style="{StaticResource SuccessBtn}"
                              Command="{Binding CompleteCommand}"
                              IsVisible="{Binding IsEditing}"/> 
                  </Grid>

                <!-- 基础信息卡片 -->
                <Frame Style="{StaticResource Card}">
                    <Grid ColumnDefinitions="85,*,85,*"
                          RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto" RowSpacing="8" ColumnSpacing="3"
                          >
                        <!-- 第一行 -->
                        <Label Grid.Row="0" Grid.Column="0" Text="维修工单号：" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="0" Grid.Column="1" Text="{Binding Detail.workOrderNo}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="0" Grid.Column="2" Text="异常提报单号：" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="0" Grid.Column="3" Text="{Binding Detail.maintainNo}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="1" Grid.Column="0" Text="设备名称：" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="1" Grid.Column="1" Text="{Binding Detail.maintainReportDomain.devName}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="1" Grid.Column="2" Text="设备编号：" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="1" Grid.Column="3" Text="{Binding Detail.maintainReportDomain.devCode}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="2" Grid.Column="0" Text="设备型号：" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="2" Grid.Column="1" Text="{Binding Detail.maintainReportDomain.devModel}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="2" Grid.Column="2" Text="车间：" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="2" Grid.Column="3" Text="{Binding Detail.maintainReportDomain.workShopName}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="3" Grid.Column="0" Text="紧急程度：" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="3" Grid.Column="1" Text="{Binding Detail.UrgentText}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="3" Grid.Column="2" Text="期望修复日期：" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="3" Grid.Column="3" Text="{Binding DetailDetail.maintainReportDomain.expectedRepairDate}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="4" Grid.Column="0" Text="指派给：" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="4" Grid.Column="1" Text="{Binding Detail.assignToName}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="4" Grid.Column="2" Text="维修内修：" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="4" Grid.Column="3" Text="{Binding Detail.MaintainTypeText}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="5" Grid.Column="0" Text="异常现象：" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="5" Grid.Column="1" Grid.ColumnSpan="3" Text="{Binding Detail.maintainReportDomain.phenomena}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="6" Grid.Column="0" Text="异常描述：" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="6" Grid.Column="1" Grid.ColumnSpan="3" Text="{Binding Detail.maintainReportDomain.description}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="7" Grid.Column="0" Text="备注：" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="7" Grid.Column="1" Grid.ColumnSpan="3" Text="{Binding Detail.maintainReportDomain.memo}" Style="{StaticResource FieldValue}" />
                    </Grid>
                </Frame>
                <!--异常提报图片-->
                <Label Text="异常提报图片" Style="{StaticResource SectionTitle}" HorizontalOptions="Start" />
                <HorizontalStackLayout Grid.Row="0" Grid.Column="1" Spacing="8" VerticalOptions="Start">

                    <CollectionView ItemsSource="{Binding ErrorAttachments}"
                                     ItemsLayout="HorizontalList"
                                     HeightRequest="96"
                                     SelectionMode="None">  
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Frame Padding="0" WidthRequest="96" HeightRequest="96"
                                            CornerRadius="8" HasShadow="False" BorderColor="#E5E7EB" Margin="0,0,8,0">
                                        <Image Aspect="AspectFill" Source="{Binding DisplaySource}" />
                                    </Frame>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </HorizontalStackLayout>

                <Label Text="维修结果"
            VerticalOptions="Start"
            Style="{StaticResource SectionTitle}" />
                <Frame Style="{StaticResource Card}">
                    <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                          ColumnDefinitions="50,*,50,*" 
                           RowSpacing="8" ColumnSpacing="2">
                        <Label Grid.Row="0" Grid.Column="0"   Text="维修结果：" Style="{StaticResource FieldLabel}" />
                        <Entry Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="3"
                               Text="{Binding Detail.repairResult}"
                               FontAttributes="Bold" IsEnabled="{Binding IsEditing}"
                               />
                        <!-- 分割线 -->
                        <BoxView Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="4" HeightRequest="1" BackgroundColor="#E5E7EB" />
                        <Label Grid.Row="2" Grid.Column="0" Text="主维修人：" Style="{StaticResource FieldLabel}" />
                        <Grid Grid.Row="2" Grid.Column="1" RowDefinitions="Auto,Auto">
                            <Entry
                                Grid.Row="0"
                                Placeholder="请输入"
                                Text="{Binding MainRepairUserText, Mode=TwoWay}"
                                IsEnabled="{Binding IsEditing}"/> 

                            <!-- 下拉列表 -->
                            <Border
                                    Grid.Row="1"
                                    IsVisible="{Binding IsMainRepairUserDropdownOpen}"
                                    Stroke="#E5E7EB"
                                    BackgroundColor="White"
                                    Padding="0"
                                    Margin="0,2,0,0"> 
                                <CollectionView
                                    ItemsSource="{Binding MainRepairUserSuggestions}"
                                    SelectionMode="None"> 
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Padding="8">
                                                <Grid.GestureRecognizers>
                                                    <TapGestureRecognizer
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PickMainRepairUserCommand}"
                                                    CommandParameter="{Binding .}" /> 
                                                </Grid.GestureRecognizers>
                                                <Label Text="{Binding realname}" />
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Border>
                        </Grid>

                        <Label Grid.Row="2" Grid.Column="2" Text="辅助维修人：" Style="{StaticResource FieldLabel}" />
                        <!-- 辅维修人：输入框 + 下拉多选 + 已选标签 -->
                        <Grid Grid.Row="2" Grid.Column="3"  RowDefinitions="Auto,Auto,Auto">
                            <Entry
                                Grid.Row="0"
                                Placeholder="请输入"
                                Text="{Binding AssitRepairUsersText, Mode=TwoWay}" IsEnabled="{Binding IsEditing}"/> 

                            <!-- 已选辅维修人标签（可选） -->
                            <FlexLayout
    Grid.Row="1"
    BindableLayout.ItemsSource="{Binding SelectedAssistRepairUsers}"
    Direction="Row"
    Wrap="Wrap"
    Margin="0,4,0,0">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate>
                                        <Frame Padding="6,2"
                   CornerRadius="10"
                   HasShadow="False"
                   BorderColor="#D1D5DB"
                   Margin="2">
                                            <Frame.GestureRecognizers>
                                                <TapGestureRecognizer
                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleAssistRepairUserCommand}"
                        CommandParameter="{Binding .}" />
                                            </Frame.GestureRecognizers>

                                            <Label Text="{Binding realname}" FontSize="12" />
                                        </Frame>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </FlexLayout>



                            <!-- 下拉候选，多选 -->
                            <Border
                                Grid.Row="2"
                                IsVisible="{Binding IsAssistRepairUserDropdownOpen}"
                                Stroke="#E5E7EB"
                                BackgroundColor="White"
                                Padding="0"
                                Margin="0,2,0,0">  
                                <CollectionView
                                    ItemsSource="{Binding AssistRepairUserSuggestions}"
                                    SelectionMode="None"> 
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Padding="8">
                                                <Grid.GestureRecognizers>
                                                    <TapGestureRecognizer
                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleAssistRepairUserCommand}"
                                CommandParameter="{Binding .}" />
                                                </Grid.GestureRecognizers>
                                                <Label Text="{Binding realname}" />
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Border>
                        </Grid>
                        <!-- 维修开始时间 -->
                        <Label Grid.Row="3" Grid.Column="0"
       Text="维修开始时间：" Style="{StaticResource FieldLabel}" />

                        <Grid Grid.Row="3" Grid.Column="1"
      ColumnDefinitions="*,Auto">
                            <!-- 日期 -->
                            <DatePicker Grid.Column="0"
                Date="{Binding Detail.RepairStartTime, Mode=TwoWay}"
                                        Format="yyyy-MM-dd"
                IsEnabled="{Binding IsEditing}" />
                            <!-- 时间 -->
                            <TimePicker Grid.Column="1"
                Time="{Binding Detail.RepairStartTimeTime, Mode=TwoWay}"
                WidthRequest="45"
                Margin="0,0,0,0"
                IsEnabled="{Binding IsEditing}" />
                        </Grid>

                        <!-- 维修结束时间 -->
                        <Label Grid.Row="3" Grid.Column="2"
       Text="维修结束时间：" Style="{StaticResource FieldLabel}" />

                        <Grid Grid.Row="3" Grid.Column="3"
      ColumnDefinitions="*,Auto">
                            <!-- 日期 -->
                            <DatePicker Grid.Column="0"
                Date="{Binding Detail.RepairEndTime, Mode=TwoWay}"
                                        Format="yyyy-MM-dd"
                IsEnabled="{Binding IsEditing}" />
                            <!-- 时间 -->
                            <TimePicker Grid.Column="1"
                Time="{Binding Detail.RepairEndTimeTime, Mode=TwoWay}"
                WidthRequest="45"
                Margin="0,0,0,0"
                IsEnabled="{Binding IsEditing}" />
                        </Grid>
                        <Label Grid.Row="4" Grid.Column="0"
       Text="维修时长：" Style="{StaticResource FieldLabel}" />
                        <Grid Grid.Row="4" Grid.Column="1" Grid.ColumnSpan="3"
      ColumnDefinitions="Auto,Auto">
                            <Entry Grid.Column="0"
           WidthRequest="80"
           Text="{Binding Detail.repairDuration,
                          Mode=OneWay,
                          StringFormat='{}{0:F2}',
                          TargetNullValue=''}"
           IsReadOnly="True"
           IsEnabled="False" />
                            <Label Grid.Column="1"
           Text="小时"
           VerticalTextAlignment="Center"
           Margin="6,0,0,0" />
                        </Grid>



                    </Grid>
                </Frame>

                <!-- 维修内容 -->
                <Label Text="维修内容" Style="{StaticResource SectionTitle}"/>

                <CollectionView ItemsSource="{Binding Items}" SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <!-- 左侧序号 + 右侧原卡片 -->
                            <Grid ColumnDefinitions="12,*" ColumnSpacing="8" Margin="0,6,0,0">
                                <!-- 序号：与卡片顶部对齐 -->
                                <Label Grid.Column="0"
                       Text="{Binding index}"
                       VerticalOptions="Center"
                       HorizontalTextAlignment="Center"
                       VerticalTextAlignment="Center"
                       FontAttributes="Bold"
                       TextColor="#111827"
                       Margin="0,8,0,0"/>

                                <!-- 右侧你的原 Frame 卡片，内容保持不变 -->
                                <Frame Grid.Column="1" Style="{StaticResource Card}">
                                    <Grid
                        RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto"
                        ColumnDefinitions="Auto,*"
                        RowSpacing="8" ColumnSpacing="5">

                                        <!-- 行0：项目名称 -->
                                        <Label Grid.Row="0" Grid.Column="0" Text="故障名称：" Style="{StaticResource FieldLabel}" />
                                        <Entry Grid.Row="0" Grid.Column="1" Text="{Binding faultName}" Style="{StaticResource FieldValue}" IsEnabled="{Binding IsEditing}" />
                                        <BoxView Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="6" HeightRequest="1" BackgroundColor="#E5E7EB" />
                                        <Label Grid.Row="2" Grid.Column="0" Text="故障描述：" Style="{StaticResource FieldLabel}" />
                                        <Entry Grid.Row="2" Grid.Column="1" Text="{Binding faultDescription}" Style="{StaticResource FieldValue}" IsEnabled="{Binding IsEditing}"/>
                                        <Label Grid.Row="3" Grid.Column="0" Text="故障原因：" Style="{StaticResource FieldLabel}" />
                                        <Entry Grid.Row="3" Grid.Column="1" Text="{Binding faultCause}" Style="{StaticResource FieldValue}" IsEnabled="{Binding IsEditing}"/>
                                        <Label Grid.Row="4" Grid.Column="0" Text="故障部位：" Style="{StaticResource FieldLabel}" />
                                        <Entry Grid.Row="4" Grid.Column="1" Text="{Binding faultPart}" Style="{StaticResource FieldValue}" IsEnabled="{Binding IsEditing}"/>
                                        <Label Grid.Row="5" Grid.Column="0" Text="维修操作方法：" Style="{StaticResource FieldLabel}" />
                                        <Entry Grid.Row="5" Grid.Column="1" Text="{Binding repairMethod}" Style="{StaticResource FieldValue}" IsEnabled="{Binding IsEditing}" />
                                        <Label Grid.Row="6" Grid.Column="0" Text="预防建议：" Style="{StaticResource FieldLabel}" />
                                        <Entry Grid.Row="6" Grid.Column="1" Text="{Binding suggestions}" Style="{StaticResource FieldValue}" IsEnabled="{Binding IsEditing}"/>
                                        <Label Grid.Row="7" Grid.Column="0" Text="备注：" Style="{StaticResource FieldLabel}" />
                                        <Entry Grid.Row="7" Grid.Column="1" Text="{Binding memo}" Style="{StaticResource FieldValue}" IsEnabled="{Binding IsEditing}"/>

                                    </Grid>
                                </Frame>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- 图片附件 -->
                <Label Text="图片附件" Style="{StaticResource SectionTitle}" HorizontalOptions="Start" />
                <!-- 左窄右宽两列 -->
                <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnDefinitions="40,*" RowSpacing="8">

                    <!-- Row0 左：图片上传标题 -->
                    <Label Grid.Row="0" Grid.Column="0" Text="图片上传：" VerticalTextAlignment="Start" />

                    <!-- Row0 右：缩略图 + 上传方块 -->
                    <HorizontalStackLayout Grid.Row="0" Grid.Column="1" Spacing="8" VerticalOptions="Start">

                        <CollectionView ItemsSource="{Binding ImageAttachments}"
                    ItemsLayout="HorizontalList"
                    HeightRequest="96"
                    SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Frame Padding="0" WidthRequest="96" HeightRequest="96"
                   CornerRadius="8" HasShadow="False" BorderColor="#E5E7EB" Margin="0,0,8,0">
                                            <Image Aspect="AspectFill" Source="{Binding DisplaySource}" />
                                        </Frame>
                                        <!-- 右上角删除 -->
                                        <Button Text="×" FontSize="12" Padding="0"
                                                WidthRequest="22" HeightRequest="22" CornerRadius="11"
                                                BackgroundColor="#00000066" TextColor="White"
                                                HorizontalOptions="End" VerticalOptions="Start" Margin="2"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteAttachmentCommand}"
                                                CommandParameter="{Binding .}"
                                                IsVisible="{Binding IsEditing}" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <!-- 上传方块 -->
                        <Frame WidthRequest="96" HeightRequest="96" CornerRadius="8"
           BorderColor="#E5E7EB" BackgroundColor="White" IsVisible="{Binding IsEditing}"
           HasShadow="False" Padding="8" VerticalOptions="Start">
                            <VerticalStackLayout Spacing="4" VerticalOptions="Center" HorizontalOptions="Center">
                                <Label Text="＋" FontSize="28" TextColor="#9CA3AF" />
                                <Label Text="单击上传" FontSize="12" TextColor="#9CA3AF" Margin="0,0,0,2" LineHeight="1.1"/>
                            </VerticalStackLayout>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer  Tapped="OnPickImagesClicked" />
                            </Frame.GestureRecognizers>
                        </Frame>
                    </HorizontalStackLayout>

                    <!-- Row1 左：附件信息标题 -->
                    <Label Grid.Row="1" Grid.Column="0" Text="附件信息：" VerticalTextAlignment="Center" />

                    <!-- Row1 右：上传附件链接 -->
                    <HorizontalStackLayout Grid.Row="1" Grid.Column="1" Spacing="12" VerticalOptions="Center" IsVisible="{Binding IsEditing}">
                        <Label Text="上传附件" TextColor="#3B82F6">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnPickFileClicked" />
                            </Label.GestureRecognizers>
                        </Label>
                    </HorizontalStackLayout>

                    <!-- Row2 右：提示 -->
                    <Label Grid.Row="2" Grid.Column="1"
         Text="（单个附件最大支持20M，支持格式PDF、Word、Excel、Txt、JPG、PNG、RAR）"
         FontSize="12" TextColor="#9CA3AF" IsVisible="{Binding IsEditing}"/>

                    <!-- Row3 右：附件表格 -->
                    <Grid Grid.Row="3" Grid.Column="1" RowDefinitions="Auto,*" Margin="0,4,0,0">
                        <Grid Grid.Row="0" ColumnDefinitions="40,100,40,80,120"
          BackgroundColor="#E5EEF9" Padding="8,8">
                            <Label Grid.Column="0" Text="序号" />
                            <Label Grid.Column="1" Text="附件名称" />
                            <Label Grid.Column="2" Text="大小" />
                            <Label Grid.Column="3" Text="上传时间" />
                            <Label Grid.Column="4" Text="操作" />
                        </Grid>

                        <CollectionView x:Name="AttList" Grid.Row="1" ItemsSource="{Binding Attachments}" SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="40,100,40,80,120" Padding="8,10">
                                        <Label Text="{Binding .,
                                            Converter={StaticResource IndexConverter},
                                            ConverterParameter={x:Reference AttList}}" />
                                        <Label Grid.Column="1" Text="{Binding AttachmentName}" LineBreakMode="TailTruncation"/>
                                        <Label Grid.Column="2" Text="{Binding AttachmentSize}" />
                                        <Label Grid.Column="3" Text="{Binding CreatedTime}" />
                                        <HorizontalStackLayout Grid.Column="4" Spacing="16">
                                            <Label Text="下载" TextColor="#3B82F6">
                                                <Label.GestureRecognizers>
                                                    <TapGestureRecognizer
                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DownloadAttachmentCommand}"
                    CommandParameter="{Binding .}" />
                                                </Label.GestureRecognizers>
                                            </Label>
                                            <Label Text="删除" TextColor="Red" IsVisible="{Binding IsEditing}">
                                                <Label.GestureRecognizers>
                                                    <TapGestureRecognizer
                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteAttachmentCommand}"
                    CommandParameter="{Binding .}" />
                                                </Label.GestureRecognizers>
                                            </Label>
                                        </HorizontalStackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                    </Grid>
                    <Grid Grid.Row="4"  Grid.Column="0" Grid.ColumnSpan="2" RowDefinitions="Auto,*">
                        <Grid Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="10">
                            <Label Grid.Column="0" Text="创建人：" Style="{StaticResource FieldLabel}" />
                            <Label Grid.Column="1" Text="{Binding Detail.creator}" Style="{StaticResource FieldValue}" />
                            <Label Grid.Column="2" Text="创建日期：" Style="{StaticResource FieldLabel}" />
                            <Label Grid.Column="3" Text="{Binding Detail.createdTime}" Style="{StaticResource FieldValue}" />
                        </Grid>
                        <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="10">
                            <Label Grid.Column="0" Text="最近修改人：" Style="{StaticResource FieldLabel}" />
                            <Label Grid.Column="1" Text="{Binding Detail.modifier}" Style="{StaticResource FieldValue}" />
                            <Label Grid.Column="2" Text="修改日期：" Style="{StaticResource FieldLabel}" />
                            <Label Grid.Column="3" Text="{Binding Detail.modifiedTime}" Style="{StaticResource FieldValue}" />
                        </Grid>
                    </Grid>
                </Grid>

            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>

