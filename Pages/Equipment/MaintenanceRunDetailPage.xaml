<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Name="ThisPage"
    x:Class="JXHLJSApp.Pages.MaintenanceRunDetailPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:conv="clr-namespace:JXHLJSApp.Converters"
    BackgroundColor="White"
    Title="è®¾å¤‡ç®¡ç†ç³»ç»Ÿ">

    <!-- å±€éƒ¨æ ·å¼ï¼šæŒ‰é’®/æ ‡é¢˜/åˆ†ç»„æ ‡é¢˜ -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:NullOrEmptyToBoolInverseConverter x:Key="NullOrEmptyToBoolInverseConverter" />
            <conv:StringToNullableDecimalConverter x:Key="DecConv" />
            <conv:DecParseOnlyConverter x:Key="DecParseOnlyConv" />
            <conv:DefectLevelToColorConverter x:Key="DefectLevelToColor"/>
            <conv:IntGreaterThanZeroConverter x:Key="IntGT0" />
            <conv:IndexConverter x:Key="IndexConverter" />
            <conv:BoolToPrimaryOrGrayConverter x:Key="BoolToPrimaryOrGray" />
            <conv:ActiveToTitleColorConverter  x:Key="ActiveToTitleColor"  />
            <conv:InspectResultToColorConverter x:Key="InspectResultToColorConverter" />
            <Style x:Key="PrimaryBtn" TargetType="Button">
                <Setter Property="HeightRequest" Value="36" />
                <Setter Property="CornerRadius" Value="8" />
                <Setter Property="Padding" Value="18,6" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="BackgroundColor" Value="#2F80ED" />
                <Setter Property="FontAttributes" Value="Bold" />
            </Style>
            <Style x:Key="SuccessBtn" TargetType="Button" BasedOn="{StaticResource PrimaryBtn}">
                <Setter Property="BackgroundColor" Value="#27AE60" />
            </Style>
            <Style x:Key="SectionTitle" TargetType="Label">
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="#1F2937" />
                <Setter Property="Margin" Value="0,5,0,4" />
            </Style>
            <Style x:Key="FieldLabel" TargetType="Label">
                <Setter Property="TextColor" Value="#4B5563" />
                <Setter Property="VerticalTextAlignment" Value="Center" />
                <Setter Property="HorizontalOptions" Value="Start" />
                <Setter Property="HorizontalTextAlignment" Value="Start" />
                <Setter Property="Padding" Value="0" />
            </Style>
            <Style x:Key="FieldValue" TargetType="Label">
                <Setter Property="TextColor" Value="#111827" />
                <Setter Property="VerticalTextAlignment" Value="Center" />
                <Setter Property="HorizontalOptions" Value="Start" />
                <Setter Property="HorizontalTextAlignment" Value="Start" />
            </Style>
            <Style x:Key="Card" TargetType="Frame">
                <Setter Property="Padding" Value="12" />
                <Setter Property="CornerRadius" Value="8" />
                <Setter Property="HasShadow" Value="False" />
                <Setter Property="BorderColor" Value="#E5E7EB" />
            </Style>
            <!-- åªè¯»å±•ç¤ºå°ç°æ¡† -->
            <Style x:Key="ReadonlyPill" TargetType="Frame">
                <Setter Property="Padding" Value="8,6" />
                <Setter Property="CornerRadius" Value="6" />
                <Setter Property="HasShadow" Value="False" />
                <Setter Property="BackgroundColor" Value="#F3F4F6" />
                <Setter Property="BorderColor" Value="#E5E7EB" />
            </Style>
            <Style TargetType="Entry">
                <Setter Property="HorizontalOptions" Value="Fill" />
                <Setter Property="Margin" Value="0" />
                <Setter Property="HeightRequest" Value="42" />
                <Setter Property="VerticalOptions" Value="Center" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="HorizontalTextAlignment" Value="Start" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid x:Name="RootGrid">

        <!-- ç‚¹å‡»ç©ºç™½å¤„æ”¶èµ·æ£€éªŒå‘˜ä¸‹æ‹‰ -->
        <Grid.GestureRecognizers>
            <TapGestureRecognizer Command="{Binding ClearUpkeepOperatorCommand}" />
        </Grid.GestureRecognizers>

        <ScrollView>
            <VerticalStackLayout Spacing="8" Padding="12">

            <Grid Grid.Row="0"  HeightRequest="56" Padding="12" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                <Label Text="ä¿å…»å•åŸºç¡€ä¿¡æ¯"
    VerticalOptions="Start"
    TextColor="Black"
    FontSize="14"
    FontAttributes="Bold" />
                    <!-- ä¿å­˜æŒ‰é’® -->
                    <Button
        Grid.Column="1"
        Text="{Binding SaveButtonText}"
        Command="{Binding SaveCommand}"
        IsEnabled="{Binding IsEditing}"
        Margin="0,0,8,0"
        Padding="12,6"
        BackgroundColor="#3B82F6"
        TextColor="White"
        CornerRadius="6"
        HorizontalOptions="End"
        VerticalOptions="Center" />

                    <!-- æäº¤ / å®Œæˆä¿å…» æŒ‰é’® -->
                    <Button
        Grid.Column="2"
        Text="{Binding ActionButtonText}"
        Command="{Binding CompleteCommand}"
        IsEnabled="{Binding IsEditing}"
        Padding="12,6"
        BackgroundColor="#10B981"
        TextColor="White"
        CornerRadius="6"
        HorizontalOptions="End"
        VerticalOptions="Center" />

                </Grid>

        <!-- ç‚¹å·¡æ£€å•åŸºç¡€ä¿¡æ¯ - å·¥ä½œæµæ—¶é—´è½´ -->
                <Grid Margin="0,8,0,0" RowDefinitions="Auto" Grid.Row="1" >
                    <CollectionView ItemsSource="{Binding WorkflowSteps}"
                    SelectionMode="None"
                    ItemsLayout="HorizontalList"
                    HorizontalOptions="Center"
                    VerticalOptions="Center">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <!-- ä¸‰è¡Œä¸¤åˆ—ï¼šè¡Œ0å›¾å½¢ï¼Œè¡Œ1æ ‡é¢˜ï¼Œè¡Œ2æ—¶é—´ -->
                                <Grid ColumnDefinitions="20,15,25,15"
          RowDefinitions="Auto,Auto,Auto"
          Padding="12,0"
          HorizontalOptions="Center" VerticalOptions="Center">

                                    <!-- åœ†ç‚¹ï¼šé»˜è®¤ç™½åº•ï¼›æ¿€æ´»(å·²å®Œæˆ/å½“å‰)æè¾¹è“ï¼Œæœªåˆ°è¾¾æè¾¹ç° -->
                                    <Frame Grid.Row="0" Grid.Column="0"
                                   WidthRequest="24" HeightRequest="24"
                                   Padding="0" HasShadow="False"
                                   CornerRadius="16"
                                   BackgroundColor="White"
                                   BorderColor="{Binding IsActive, Converter={StaticResource BoolToPrimaryOrGray}}"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center">

                                        <!-- è¿™é‡Œåªæ”¾ä¸€ä¸ªå†…å®¹ï¼šGrid å æ”¾ä¸¤ä¸ª Labelï¼Œé¿å…â€œContent è¢«è®¾ç½®å¤šæ¬¡â€ -->
                                        <Grid>
                                            <!-- å½“å‰æ­¥éª¤ï¼šè“åº•ç™½å­—æ•°å­—ï¼ˆå¯è§æ€§äº’æ–¥ï¼‰ -->
                                            <Label Text="{Binding StepNo}"
               FontSize="14"
               FontAttributes="Bold"
               TextColor="White"
               HorizontalOptions="Center"
               VerticalOptions="Center"
               IsVisible="{Binding IsCurrent}" />

                                            <!-- å·²å®Œæˆï¼šè“è‰²å¯¹å‹¾ï¼ˆå­—ç¬¦ï¼›å¦‚æžœå¤ªç»†å¯æŠŠ FontSize è°ƒåˆ° 20~22ï¼‰ -->
                                            <Label Text="âœ“"
               FontSize="18"
               FontAttributes="Bold"
               TextColor="{Binding IsActive, Converter={StaticResource BoolToPrimaryOrGray}}"
               HorizontalOptions="Center"
               VerticalOptions="Center"
               IsVisible="{Binding IsCompleted}" />
                                        </Grid>

                                        <!-- å…³é”®ï¼šè§¦å‘å™¨å†™åœ¨ Frame ä¸Šï¼Œç›´æŽ¥æ”¹ Frame çš„åº•è‰²ä¸Žæè¾¹ -->
                                        <Frame.Triggers>
                                            <DataTrigger TargetType="Frame" Binding="{Binding IsCurrent}" Value="True">
                                                <Setter Property="BackgroundColor" Value="#3B82F6" />
                                                <Setter Property="BorderColor"     Value="#3B82F6" />
                                            </DataTrigger>
                                        </Frame.Triggers>
                                    </Frame>
                                    <!-- æ ‡é¢˜ï¼šæ¿€æ´»(å·²å®Œæˆ/å½“å‰)ä¸ºæ·±è‰²ï¼Œæœªåˆ°è¾¾ä¸ºç° -->
                                    <Label Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="2"
           Text="{Binding Title}"
           FontSize="13"
           TextColor="{Binding IsActive, Converter={StaticResource ActiveToTitleColor}}"
           HorizontalTextAlignment="Center" VerticalOptions="Center"/>

                                    <!-- è¿žçº¿ï¼šå½“å‰æˆ–å·²å®Œæˆä¸ºè“ï¼Œå¦åˆ™ç°ï¼›æœ€åŽä¸€ä¸ªéšè— -->
                                    <BoxView Grid.Row="0" Grid.Column="3"
                 WidthRequest="20" HeightRequest="2"
                 VerticalOptions="Center" HorizontalOptions="Center"
                 BackgroundColor="{Binding IsActive, Converter={StaticResource BoolToPrimaryOrGray}}">
                                        <BoxView.Triggers>
                                            <DataTrigger TargetType="BoxView" Binding="{Binding IsLast}" Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </BoxView.Triggers>
                                    </BoxView>



                                    <!-- æ—¶é—´ï¼šåªæœ‰æœ‰å€¼æ‰æ˜¾ç¤ºï¼ˆå½“å‰ä¸Žå·²å®Œæˆéƒ½æœ‰æ—¶é—´ï¼‰ï¼›æœªåˆ°è¾¾ä¸æ˜¾ç¤º -->
                                    <Label Grid.Row="2"  Grid.Column="1" Grid.ColumnSpan="3"
                                   Text="{Binding Time}"
                                   FontSize="11"
                                   TextColor="#888888"
                                   HorizontalTextAlignment="Center">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding Time}" Value="">
                                                <Setter Property="IsVisible" Value="False"/>
                                            </DataTrigger>
                                            <DataTrigger TargetType="Label" Binding="{Binding Time}" Value="{x:Null}">
                                                <Setter Property="IsVisible" Value="False"/>
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>

                <!-- åŸºç¡€ä¿¡æ¯å¡ç‰‡ -->
                <Frame Style="{StaticResource Card}">
                    <Grid ColumnDefinitions="80,*,80,*"
                          RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" RowSpacing="8" ColumnSpacing="5"
                          >

                        <!-- ç¬¬ä¸€è¡Œ -->
                        <Label Grid.Row="0" Grid.Column="0" Text="ä¿å…»å•å·ï¼š" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="0" Grid.Column="1" Text="{Binding Detail.upkeepNo}" Style="{StaticResource FieldValue}" />

                        <Label Grid.Row="0" Grid.Column="2" Text="è®¡åˆ’åç§°ï¼š" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="0" Grid.Column="3" Text="{Binding Detail.planName}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="1" Grid.Column="0" Text="è®¡åˆ’ç¼–å·ï¼š" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="1" Grid.Column="1" Text="{Binding Detail.planCode}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="1" Grid.Column="2" Text="è®¾å¤‡åç§°ï¼š" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="1" Grid.Column="3" Text="{Binding Detail.devName}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="2" Grid.Column="0" Text="è®¾å¤‡ç¼–å·ï¼š" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="2" Grid.Column="1" Text="{Binding Detail.devCode}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="2" Grid.Column="2" Text="è®¡åˆ’ä¿å…»æ—¥æœŸï¼š" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="2" Grid.Column="3" Text="{Binding Detail.planUpkeepTime}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="3" Grid.Column="0" Text="åˆ›å»ºæ—¥æœŸï¼š" Style="{StaticResource FieldLabel}" />
                        <DatePicker Grid.Row="3" Grid.Column="1" Date="{Binding Detail.createdTime}" />
                        <Label Grid.Row="3" Grid.Column="2" Text="æ“ä½œäººï¼š" Style="{StaticResource FieldLabel}" />
                        <Grid Grid.Row="3" Grid.Column="3" >
                            <Entry
                                Text="{Binding UpkeepOperator, Mode=TwoWay}"
                                Placeholder="è¯·è¾“å…¥"
                                Completed="OnUpkeepOperatorEntryCompleted"/> 
                            <!-- ä¸‹æ‹‰æµ®å±‚ -->
                            <Frame HasShadow="True" Padding="0" Margin="0,40,0,0"
                                IsVisible="{Binding IsUpkeepOperatorDropdownOpen}"
                                ZIndex="9999" CornerRadius="8"
                                BackgroundColor="White" BorderColor="#E5E7EB"> 
                                <CollectionView ItemsSource="{Binding UpkeepOperatorSuggestions}" HeightRequest="220">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Padding="10" ColumnDefinitions="Auto,*">
                                                <Label Grid.Column="0" Text="ðŸ‘¤"/>
                                                <Label Grid.Column="1" Text="{Binding realname}"/>
                                                <Grid.GestureRecognizers>
                                                    <TapGestureRecognizer
                     Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PickUpkeepOperatorCommand}"
                     CommandParameter="{Binding .}"/>
                                                </Grid.GestureRecognizers>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Frame>
                        </Grid>
                        <Label Grid.Row="4" Grid.Column="0" Text="å¤‡æ³¨ï¼š" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="4" Grid.Column="1" Grid.ColumnSpan="3" Text="{Binding Detail.memo}" Style="{StaticResource FieldValue}" />
                        <Label Grid.Row="5" Grid.Column="0" Text="ä¿å…»å¤‡æ³¨ï¼š" Style="{StaticResource FieldLabel}" />
                        <Label Grid.Row="5" Grid.Column="1" Grid.ColumnSpan="3" Text="{Binding Detail.upkeepMemo}" Style="{StaticResource FieldValue}" />
                    </Grid>
                </Frame>

                <!-- ä¿å…»é¡¹ç›®æ‰§è¡Œ -->
                <Grid ColumnDefinitions="*,120">
                    <Label Text="ä¿å…»é¡¹ç›®æ‰§è¡Œ" Style="{StaticResource SectionTitle}"/>
                    <Button Grid.Column="1"
                            Text="ä¸€é”®å®Œæˆ"
                            Style="{StaticResource PrimaryBtn}"
                            Command="{Binding SetAllUpkeepCommand}"
                            IsVisible="{Binding IsEditing}"/> 
                </Grid>
                <CollectionView ItemsSource="{Binding Items}" SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <!-- å·¦ä¾§åºå· + å³ä¾§åŽŸå¡ç‰‡ -->
                            <Grid ColumnDefinitions="12,*" ColumnSpacing="8" Margin="0,6,0,0">
                                <!-- åºå·ï¼šä¸Žå¡ç‰‡é¡¶éƒ¨å¯¹é½ -->
                                <Label Grid.Column="0"
                       Text="{Binding index}"
                       VerticalOptions="Center"
                       HorizontalTextAlignment="Center"
                       VerticalTextAlignment="Center"
                       FontAttributes="Bold"
                       TextColor="#111827"
                       Margin="0,8,0,0"/>

                                <!-- å³ä¾§ä½ çš„åŽŸ Frame å¡ç‰‡ï¼Œå†…å®¹ä¿æŒä¸å˜ -->
                                <Frame Grid.Column="1" Style="{StaticResource Card}">
                                    <Grid
                        RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto"
                        ColumnDefinitions="Auto,*"
                        RowSpacing="8" ColumnSpacing="5">

                                        <Label Grid.Row="0" Grid.Column="0" Text="é¡¹ç›®åç§°ï¼š" Style="{StaticResource FieldLabel}" />
                                        <Label Grid.Row="0" Grid.Column="1" Text="{Binding itemName}" Style="{StaticResource FieldValue}" />
                                        <BoxView Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="4" HeightRequest="1" BackgroundColor="#E5E7EB" />

                                        <Grid Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                              ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="10">
                                            <Label Grid.Column="0" Text="ä¿å…»å†…å®¹ï¼š" Style="{StaticResource FieldLabel}" />
                                            <Label Grid.Column="1" Grid.ColumnSpan="3" Text="{Binding upkeepContent}" Style="{StaticResource FieldValue}" />
                                        </Grid>
                                        <Grid Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                            <Label Grid.Column="0" Text="æ“ä½œæ–¹æ³•åŠæ ‡å‡†ï¼š" Style="{StaticResource FieldLabel}" />
                                            <Label Grid.Column="1" Grid.ColumnSpan="3" Text="{Binding upkeepStandard}" Style="{StaticResource FieldValue}" />
                                        </Grid>

                                        <Grid Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2"
                              ColumnDefinitions="Auto,*,Auto,*,Auto,*" ColumnSpacing="10">
                                            <Label Grid.Column="0" Text="è€—æï¼š" Style="{StaticResource FieldLabel}" />
                                            <Label Grid.Column="1" Grid.ColumnSpan="3" Text="{Binding consumeMaterial}" Style="{StaticResource FieldValue}" />
                                        </Grid>
                                        <Grid Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="2"
                                                ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="10">
                                            <Label Grid.Column="0" Text="å·¥å…·ï¼š" Style="{StaticResource FieldLabel}" />
                                            <Label Grid.Column="1" Grid.ColumnSpan="3" Text="{Binding upkeepTool}" Style="{StaticResource FieldValue}" />
                                        </Grid>
                                        <Grid Grid.Row="6" Grid.Column="0" Grid.ColumnSpan="2"
        ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="10">
                                            <Label Grid.Column="0" Text="ä¿å…»ç»“æžœï¼š" Style="{StaticResource FieldLabel}" />
                                            <Picker x:Name="RowResultPicker"
                           Grid.Column="1" Grid.ColumnSpan="3"
                           ItemsSource="{Binding Source={x:Reference ThisPage}, Path=BindingContext.MaintenanceResultTextList}"
                           SelectedItem="{Binding upkeepResultText, Mode=TwoWay}"
                           IsEnabled="{Binding Source={x:Reference ThisPage}, Path=BindingContext.IsEditing}">
                                                <!-- é»˜è®¤åº•è‰²ï¼ˆå¯é€‰ï¼‰ -->
                                                <Picker.BackgroundColor>#F3F4F6</Picker.BackgroundColor>

                                                <Picker.Triggers>
                                                    <!-- ç›´æŽ¥ç›‘å¬æŽ§ä»¶è‡ªå·±çš„ SelectedItemï¼Œé¿å…ä¾èµ–æ¨¡åž‹çš„é€šçŸ¥ -->
                                                    <DataTrigger TargetType="Picker"
Binding="{Binding Source={x:Reference RowResultPicker}, Path=SelectedItem}"
Value="å®Œæˆ">
                                                        <Setter Property="BackgroundColor" Value="#B2F2BB"/>
                                                    </DataTrigger>

                                                    <DataTrigger TargetType="Picker"
Binding="{Binding Source={x:Reference RowResultPicker}, Path=SelectedItem}"
Value="æœªå®Œæˆ">
                                                        <Setter Property="BackgroundColor" Value="#FFA8A8"/>
                                                    </DataTrigger>
                                                </Picker.Triggers>
                                            </Picker>
                                        </Grid>
                                        <Grid Grid.Row="7" Grid.Column="0" Grid.ColumnSpan="2"
ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="10">
                                            <Label Grid.Column="0" Text="å¤‡æ³¨ï¼š" Style="{StaticResource FieldLabel}" />
                                            <Entry Grid.Column="1" Grid.ColumnSpan="3"
Text="{Binding memo, Mode=TwoWay}"
IsEnabled="{Binding IsEditing}" />
                                        </Grid>
                                    </Grid>
                                </Frame>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- å›¾ç‰‡é™„ä»¶ -->
                <Label Text="å›¾ç‰‡é™„ä»¶" Style="{StaticResource SectionTitle}" HorizontalOptions="Start" />
                <!-- å·¦çª„å³å®½ä¸¤åˆ— -->
                <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnDefinitions="40,*" RowSpacing="8">

                    <!-- Row0 å·¦ï¼šå›¾ç‰‡ä¸Šä¼ æ ‡é¢˜ -->
                    <Label Grid.Row="0" Grid.Column="0" Text="å›¾ç‰‡ä¸Šä¼ ï¼š" VerticalTextAlignment="Start" />

                    <!-- Row0 å³ï¼šç¼©ç•¥å›¾ + ä¸Šä¼ æ–¹å— -->
                    <HorizontalStackLayout Grid.Row="0" Grid.Column="1" Spacing="8" VerticalOptions="Start">

                        <CollectionView ItemsSource="{Binding ImageAttachments}"
                    ItemsLayout="HorizontalList"
                    HeightRequest="96"
                    SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Frame Padding="0" WidthRequest="96" HeightRequest="96"
                   CornerRadius="8" HasShadow="False" BorderColor="#E5E7EB" Margin="0,0,8,0">
                                            <Image Aspect="AspectFill" Source="{Binding DisplaySource}" />
                                        </Frame>
                                        <!-- å³ä¸Šè§’åˆ é™¤ -->
                                        <Button Text="Ã—" FontSize="12" Padding="0"
                                                WidthRequest="22" HeightRequest="22" CornerRadius="11"
                                                BackgroundColor="#00000066" TextColor="White"
                                                HorizontalOptions="End" VerticalOptions="Start" Margin="2"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteAttachmentCommand}"
                                                CommandParameter="{Binding .}"
                                                IsVisible="{Binding IsEditing}" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <!-- ä¸Šä¼ æ–¹å— -->
                        <Frame WidthRequest="96" HeightRequest="96" CornerRadius="8"
           BorderColor="#E5E7EB" BackgroundColor="White" IsVisible="{Binding IsEditing}"
           HasShadow="False" Padding="8" VerticalOptions="Start">
                            <VerticalStackLayout Spacing="4" VerticalOptions="Center" HorizontalOptions="Center">
                                <Label Text="ï¼‹" FontSize="28" TextColor="#9CA3AF" />
                                <Label Text="å•å‡»ä¸Šä¼ " FontSize="12" TextColor="#9CA3AF" Margin="0,0,0,2" LineHeight="1.1"/>
                            </VerticalStackLayout>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer  Tapped="OnPickImagesClicked" />
                            </Frame.GestureRecognizers>
                        </Frame>
                    </HorizontalStackLayout>

                    <!-- Row1 å·¦ï¼šé™„ä»¶ä¿¡æ¯æ ‡é¢˜ -->
                    <Label Grid.Row="1" Grid.Column="0" Text="é™„ä»¶ä¿¡æ¯ï¼š" VerticalTextAlignment="Center" />

                    <!-- Row1 å³ï¼šä¸Šä¼ é™„ä»¶é“¾æŽ¥ -->
                    <HorizontalStackLayout Grid.Row="1" Grid.Column="1" Spacing="12" VerticalOptions="Center" IsVisible="{Binding IsEditing}">
                        <Label Text="ä¸Šä¼ é™„ä»¶" TextColor="#3B82F6">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnPickFileClicked" />
                            </Label.GestureRecognizers>
                        </Label>
                    </HorizontalStackLayout>

                    <!-- Row2 å³ï¼šæç¤º -->
                    <Label Grid.Row="2" Grid.Column="1"
         Text="ï¼ˆå•ä¸ªé™„ä»¶æœ€å¤§æ”¯æŒ20Mï¼Œæ”¯æŒæ ¼å¼PDFã€Wordã€Excelã€Txtã€JPGã€PNGã€RARï¼‰"
         FontSize="12" TextColor="#9CA3AF" IsVisible="{Binding IsEditing}"/>

                    <!-- Row3 å³ï¼šé™„ä»¶è¡¨æ ¼ -->
                    <Grid Grid.Row="3" Grid.Column="1" RowDefinitions="Auto,*" Margin="0,4,0,0">
                        <Grid Grid.Row="0" ColumnDefinitions="40,100,40,80,120"
          BackgroundColor="#E5EEF9" Padding="8,8">
                            <Label Grid.Column="0" Text="åºå·" />
                            <Label Grid.Column="1" Text="é™„ä»¶åç§°" />
                            <Label Grid.Column="2" Text="å¤§å°" />
                            <Label Grid.Column="3" Text="ä¸Šä¼ æ—¶é—´" />
                            <Label Grid.Column="4" Text="æ“ä½œ" />
                        </Grid>

                        <CollectionView x:Name="AttList" Grid.Row="1" ItemsSource="{Binding Attachments}" SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="40,100,40,80,120" Padding="8,10">
                                        <Label Text="{Binding .,
                                            Converter={StaticResource IndexConverter},
                                            ConverterParameter={x:Reference AttList}}" />
                                        <Label Grid.Column="1" Text="{Binding AttachmentName}" LineBreakMode="TailTruncation"/>
                                        <Label Grid.Column="2" Text="{Binding AttachmentSize}" />
                                        <Label Grid.Column="3" Text="{Binding CreatedTime}" />
                                        <HorizontalStackLayout Grid.Column="4" Spacing="16">
                                            <Label Text="ä¸‹è½½" TextColor="#3B82F6">
                                                <Label.GestureRecognizers>
                                                    <TapGestureRecognizer
                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DownloadAttachmentCommand}"
                    CommandParameter="{Binding .}" />
                                                </Label.GestureRecognizers>
                                            </Label>
                                            <Label Text="åˆ é™¤" TextColor="Red" IsVisible="{Binding IsEditing}">
                                                <Label.GestureRecognizers>
                                                    <TapGestureRecognizer
                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteAttachmentCommand}"
                    CommandParameter="{Binding .}" />
                                                </Label.GestureRecognizers>
                                            </Label>
                                        </HorizontalStackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                    </Grid>
                    <Grid Grid.Row="4"  Grid.Column="0" Grid.ColumnSpan="2" RowDefinitions="Auto,*">
                        <Grid Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="10">
                            <Label Grid.Column="0" Text="åˆ›å»ºäººï¼š" Style="{StaticResource FieldLabel}" />
                            <Label Grid.Column="1" Text="{Binding Detail.creator}" Style="{StaticResource FieldValue}" />
                            <Label Grid.Column="2" Text="åˆ›å»ºæ—¥æœŸï¼š" Style="{StaticResource FieldLabel}" />
                            <Label Grid.Column="3" Text="{Binding Detail.createdTime}" Style="{StaticResource FieldValue}" />
                        </Grid>
                        <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="10">
                            <Label Grid.Column="0" Text="æœ€è¿‘ä¿®æ”¹äººï¼š" Style="{StaticResource FieldLabel}" />
                            <Label Grid.Column="1" Text="{Binding Detail.modifier}" Style="{StaticResource FieldValue}" />
                            <Label Grid.Column="2" Text="ä¿®æ”¹æ—¥æœŸï¼š" Style="{StaticResource FieldLabel}" />
                            <Label Grid.Column="3" Text="{Binding Detail.modifiedTime}" Style="{StaticResource FieldValue}" />
                        </Grid>
                    </Grid>
                </Grid>


            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>

