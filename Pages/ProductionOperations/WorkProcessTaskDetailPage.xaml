<ContentPage
    x:Class="IndustrialControlMAUI.Pages.WorkProcessTaskDetailPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:IndustrialControlMAUI.ViewModels"
    xmlns:conv="clr-namespace:IndustrialControlMAUI.Converters"
    BackgroundColor="White"
    Title="生产管理系统">
    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:InverseBoolConverter x:Key="InverseBoolConverter" />
            <conv:ProcessBoolToColorConverter x:Key="BoolToColor" />
            <conv:IndexConverter x:Key="IndexConverter" />
            <Style x:Key="TopActionButton" TargetType="Button">
                <Setter Property="HeightRequest" Value="36" />
                <Setter Property="CornerRadius" Value="8" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="Padding" Value="18,6" />
            </Style>
            <Style x:Key="BtnGreen" BasedOn="{StaticResource TopActionButton}" TargetType="Button">
                <Setter Property="BackgroundColor" Value="#12C312" />
            </Style>
            <Style x:Key="BtnOrange" BasedOn="{StaticResource TopActionButton}" TargetType="Button">
                <Setter Property="BackgroundColor" Value="#FF7A00" />
            </Style>
            <Style x:Key="BtnBlue" BasedOn="{StaticResource TopActionButton}" TargetType="Button">
                <Setter Property="BackgroundColor" Value="#1E76FF" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid x:Name="RootGrid" RowDefinitions="Auto,Auto,*,Auto" Padding="12" RowSpacing="10">
        <Label Grid.Row="0" Text="工单基础信息" FontAttributes="Bold" Margin="0,8,0,4"/>
        <Grid Grid.Row="1" ColumnDefinitions="Auto,Auto,Auto,*,Auto" ColumnSpacing="10">
            <Button Text="开工"
            Style="{StaticResource BtnGreen}"
            Command="{Binding StartWorkCommand}"
            IsEnabled="{Binding CanStart}" />

            <Button Grid.Column="1"
            Text="{Binding PauseResumeText}" 
                Style="{StaticResource BtnOrange}"
            Command="{Binding PauseResumeCommand}"
            IsEnabled="{Binding CanPauseResume}" />

                <Button Grid.Column="2"
            Text="完工"
            Style="{StaticResource BtnBlue}"
            Command="{Binding FinishCommand}"
            IsEnabled="{Binding CanFinish}" />
        </Grid>
        <!-- 基础信息卡片 -->
        <!-- 可编辑区（开工后启用） -->
        <ScrollView x:Name="BodyScroll" Grid.Row="2">
            <VerticalStackLayout x:Name="BodyStack" Spacing="10" HorizontalOptions="Fill">

                <Frame Padding="12" HasShadow="False" BorderColor="#E5E7EB" CornerRadius="8">
                    <Grid ColumnDefinitions="Auto,*,Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                           ColumnSpacing="8" RowSpacing="8">

                        <!-- 第一行 -->
                        <Label Grid.Row="0" Grid.Column="0" Text="工单号：" />
                        <Label Grid.Row="0" Grid.Column="1" Text="{Binding Detail.workOrderNo}" />

                        <Label Grid.Row="0" Grid.Column="2" Text="产品名称：" />
                        <Label Grid.Row="0" Grid.Column="3" Text="{Binding Detail.materialName}" />

                        <!-- 第二行 -->
                        <Label Grid.Row="1" Grid.Column="0" Text="工单名称：" />
                        <Label Grid.Row="1" Grid.Column="1" Text="{Binding Detail.workOrderName}" />

                        <Label Grid.Row="1" Grid.Column="2" Text="生产数量：" />
                        <Label Grid.Row="1" Grid.Column="3" Text="{Binding Detail.scheQty, StringFormat='{0:G29}'}" />

                        <!-- 第三行 -->
                        <Label Grid.Row="2" Grid.Column="0" Text="工序：" FontAttributes="Bold"/>
                        <Label Grid.Row="2" Grid.Column="1" Text="{Binding Detail.processName}" FontAttributes="Bold"/>

                        <Label Grid.Row="2" Grid.Column="2" Text="班次：" FontAttributes="Bold"/>
                        <Picker Grid.Row="2" Grid.Column="3"
                                ItemsSource="{Binding ShiftOptions}"
                                ItemDisplayBinding="{Binding Text}"
                                SelectedItem="{Binding SelectedShift, Mode=TwoWay}"
                                IsEnabled="{Binding IsEditing}" /> 

                        <!-- 第四行 -->
                        <Label Grid.Row="3" Grid.Column="0" Text="生产设备：" />
                        <Picker Grid.Row="3" Grid.Column="1"
                                ItemsSource="{Binding DeviceOptions}"
                                ItemDisplayBinding="{Binding Text}"
                                SelectedItem="{Binding SelectedDevice, Mode=TwoWay}"
                                IsEnabled="{Binding IsEditing}" /> 

                        <Label Grid.Row="3" Grid.Column="2" Text="报工数量：" />
                        <Entry Grid.Row="3"
                               Grid.Column="3"
                               Placeholder="请输入"
                               Text="{Binding ReportQty}"
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsEditing}"
                               Completed="OnReportQtyCompleted" /> 
                        <!-- 第五行 -->
                        <Label Grid.Row="4" Grid.Column="0" Text="操作人：" />
                        <Label Grid.Row="4" Grid.Column="1" Grid.ColumnSpan="3" Text="{Binding CurrentUserName}" />
                    </Grid>
                </Frame>

                <!-- Segmented：整条紫色底 + 白色滑块（拉满宽度、圆角一致、上边露紫多一点、带阴影） -->
                <Grid x:Name="Seg"
     
      HeightRequest="46"
      Margin="0,8,0,6"
      HorizontalOptions="Fill"
                      >
                    <!-- 关键：让容器拉满宽度 -->

                    <!-- 紫色背景：铺满整条 -->
                    <Border
      BackgroundColor="#5B3FF3"
      StrokeThickness="0"
      StrokeShape="RoundRectangle 14"     
      HorizontalOptions="Fill"
      VerticalOptions="Fill"
      InputTransparent="True"
                        
                       />
                    <Grid  ColumnDefinitions="*,*">
                    <!-- 白色滑块：默认在左列；上边留更大间距以露出更多紫色；带轻微阴影 -->
                        <Border x:Name="Knob"
                                  Grid.Column="0"
                                  BackgroundColor="White"
                                  StrokeThickness="0"
                                  StrokeShape="RoundRectangle 12"
                                  Margin="6,7,6,5"               
                                  HorizontalOptions="Fill"
                                  VerticalOptions="Fill"
                                  InputTransparent="True"> 
                            <Border.Shadow>
                                <Shadow Brush="#33000000" Offset="0,2" Radius="10" Opacity="0.35"/>
                            </Border.Shadow>
                        </Border>
                   
                    <!-- 左：投料（选中→紫字；未选中→白字） -->
                        <Grid Grid.Column="0">
                            <Label Text="投料"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   FontAttributes="Bold"
                                   TextColor="White"> 
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label" Binding="{Binding ActiveTab}" Value="Input">
                                        <Setter Property="TextColor" Value="#5B3FF3"/>
                                    </DataTrigger>
                                    <DataTrigger TargetType="Label" Binding="{Binding ActiveTab}" Value="Output">
                                        <Setter Property="TextColor" Value="White"/>
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ShowInputCommand}" />
                                <SwipeGestureRecognizer Direction="Right" Command="{Binding ShowInputCommand}" />
                            </Grid.GestureRecognizers>
                        </Grid>

                        <!-- 右：产出（选中→紫字；未选中→白字） -->
                        <Grid Grid.Column="1">
                        <Label Text="产出"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               FontAttributes="Bold"
                               TextColor="White"> 
                            <Label.Triggers>
                                    <DataTrigger TargetType="Label" Binding="{Binding ActiveTab}" Value="Output">
                                        <Setter Property="TextColor" Value="#5B3FF3"/>
                                    </DataTrigger>
                                    <DataTrigger TargetType="Label" Binding="{Binding ActiveTab}" Value="Input">
                                        <Setter Property="TextColor" Value="White"/>
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ShowOutputCommand}" />
                                <SwipeGestureRecognizer Direction="Left" Command="{Binding ShowOutputCommand}" />
                            </Grid.GestureRecognizers>
                        </Grid>
                </Grid>
                </Grid>

                <!-- 标题 -->
                <Label Text="配料明细" FontAttributes="Bold" Margin="0,8,0,4"
       IsVisible="{Binding IsInputVisible}" />

                <!-- 表头 -->
                <Grid ColumnDefinitions="40,80,60,60,60,60"
                  BackgroundColor="#F0F0F0"
                  Padding="4"
                  RowSpacing="1"
                  ColumnSpacing="1"
                  IsVisible="{Binding IsInputVisible}">
                    <Label Text="序号" FontAttributes="Bold" />
                    <Label Text="物料名称" Grid.Column="1" FontAttributes="Bold" />
                    <Label Text="单位" Grid.Column="2" FontAttributes="Bold" />
                    <Label Text="应投数量" Grid.Column="3" FontAttributes="Bold" />
                    <Label Text="已投数量" Grid.Column="4" FontAttributes="Bold" />
                    <Label Text="已投次数" Grid.Column="5" FontAttributes="Bold" />
                </Grid>

                <!-- 数据行 -->
                <CollectionView 
                                x:Name="MaterialInputView"
                                ItemsSource="{Binding Detail.materialInputList}" 
                                SelectionMode="Single"
                                SelectedItem="{Binding SelectedMaterialItem}" 
                                IsVisible="{Binding IsInputVisible}"
                                >
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="40,80,60,60,60,60"
                              Padding="4"
                              RowSpacing="1"
                              ColumnSpacing="1"
                              BackgroundColor="White">
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup Name="CommonStates">
                                        <VisualState Name="Normal" />
                                        <VisualState Name="Selected">
                                            <VisualState.Setters>
                                                <Setter Property="BackgroundColor" Value="#FFF6E5" />
                                                <!-- 淡橙色高亮 -->
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                                <Label Text="{Binding ., Converter={StaticResource IndexConverter}, ConverterParameter={x:Reference MaterialInputView}}" />
                                <Label Grid.Column="1" Text="{Binding materialName}" />
                                <Label Grid.Column="2" Text="{Binding unit}" />
                                <Label Grid.Column="3" Text="{Binding qty, StringFormat='{0:G29}'}" />
                                <Label Grid.Column="4" Text="{Binding hasInputQty, StringFormat='{0:G29}'}" />
                                <Label Grid.Column="5" Text="{Binding hasInputCount}" />
                                
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                <!-- ② 新增投料按钮 -->
                <Grid Margin="0,12,0,8" IsVisible="{Binding IsInputVisible}">
                    <Button Text="＋ 新增投料"
            HorizontalOptions="Start"
            Command="{Binding AddMaterialInputCommand}" />
                </Grid>

                <!-- ③ 投料记录表头 -->
                <Grid ColumnDefinitions="40,60,40,60,80,60,60"
      BackgroundColor="#E8F0FE"
      Padding="4"
      RowSpacing="1"
      ColumnSpacing="1"
                      IsVisible="{Binding IsInputVisible}">
                    <Label Text="序号" FontAttributes="Bold" />
                    <Label Text="物料名称" Grid.Column="1" FontAttributes="Bold" />
                    <Label Text="单位" Grid.Column="2" FontAttributes="Bold" />
                    <Label Text="投入数量" Grid.Column="3" FontAttributes="Bold" />
                    <Label Text="原料生产日期" Grid.Column="4" FontAttributes="Bold" />
                    <Label Text="备注" Grid.Column="5" FontAttributes="Bold" />
                    <Label Text="操作" Grid.Column="6" FontAttributes="Bold" />
                </Grid>

                <!-- ④ 投料记录列表 -->
                <CollectionView x:Name="MaterialListView" ItemsSource="{Binding MaterialInputRecords}" IsVisible="{Binding IsInputVisible}" >
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="40,60,40,60,80,60,60"
                  Padding="4"
                  RowSpacing="1"
                  ColumnSpacing="1"
                  BackgroundColor="White">
                                <Label Text="{Binding ., Converter={StaticResource IndexConverter}, ConverterParameter={x:Reference MaterialListView}}" />
                                <Label Grid.Column="1" Text="{Binding MaterialName}" />
                                <Label Grid.Column="2" Text="{Binding Unit}" />
                                <Label Grid.Column="3" Text="{Binding Qty, StringFormat='{0:G29}'}" />
                                <Label Grid.Column="4" Text="{Binding RawMaterialProductionDate, StringFormat='{0:yyyy-M-d HH:mm}'}" />
                                <Label Grid.Column="5" Text="{Binding Memo}" />
                                <Label Grid.Column="6"
                       Text="删除"
                       TextColor="Red">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteMaterialInputCommand}"
                                              CommandParameter="{Binding .}" />
                                    </Label.GestureRecognizers>
                                </Label>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <Label Text="应产出明细" FontAttributes="Bold" Margin="0,8,0,4"
       IsVisible="{Binding IsOutputVisible}" />
                <!-- 表头 -->
                <Grid ColumnDefinitions="40,80,60,60,60,60"
                  BackgroundColor="#F0F0F0"
                  Padding="4"
                  RowSpacing="1"
                  ColumnSpacing="1"
                  IsVisible="{Binding IsOutputVisible}">
                    <Label Text="序号" FontAttributes="Bold" />
                    <Label Text="物料名称" Grid.Column="1" FontAttributes="Bold" />
                    <Label Text="单位" Grid.Column="2" FontAttributes="Bold" />
                    <Label Text="应投数量" Grid.Column="3" FontAttributes="Bold" />
                    <Label Text="已投数量" Grid.Column="4" FontAttributes="Bold" />
                    <Label Text="已投次数" Grid.Column="5" FontAttributes="Bold" />
                </Grid>

                <!-- 数据行 -->
                <CollectionView x:Name="OutputListView"
                    ItemsSource="{Binding Detail.materialOutputList}" 
                                IsVisible="{Binding IsOutputVisible}"
                                SelectionMode="Single"
                                SelectedItem="{Binding SelectedOutputPlanItem}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="40,80,60,60,60,60"
                              Padding="4"
                              RowSpacing="1"
                              ColumnSpacing="1"
                              BackgroundColor="White">
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup Name="CommonStates">
                                        <VisualState Name="Normal" />
                                        <VisualState Name="Selected">
                                            <VisualState.Setters>
                                                <Setter Property="BackgroundColor" Value="#FFF6E5"/>
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>

                                <Label Text="{Binding ., Converter={StaticResource IndexConverter}, ConverterParameter={x:Reference OutputListView}}" />
                                <Label Grid.Column="1" Text="{Binding materialName}" />
                                <Label Grid.Column="2" Text="{Binding unit}" />
                                <Label Grid.Column="3" Text="{Binding qty, StringFormat='{0:G29}'}" />
                                <Label Grid.Column="4" Text="{Binding hasInputQty, StringFormat='{0:G29}'}" />
                                <Label Grid.Column="5" Text="{Binding hasInputCount}" />
                            </Grid>
                            
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                <!-- 新增产出按钮 -->
                <Grid Margin="0,12,0,8" IsVisible="{Binding IsOutputVisible}">
                    <Button Text="＋ 新增产出"
            HorizontalOptions="Start"
            Command="{Binding AddOutputCommand}" />
                </Grid>

                <!-- 产出记录表头 -->
                <Grid ColumnDefinitions="40,60,40,60,80,60,60"
                      BackgroundColor="#E8F0FE"
                      Padding="4"
                      RowSpacing="1"
                      ColumnSpacing="1"
                      IsVisible="{Binding IsOutputVisible}"> 
                    <Label Text="序号" FontAttributes="Bold" />
                    <Label Text="物料名称" Grid.Column="1" FontAttributes="Bold" />
                    <Label Text="单位" Grid.Column="2" FontAttributes="Bold" />
                    <Label Text="产出数量" Grid.Column="3" FontAttributes="Bold" />
                    <Label Text="操作时间" Grid.Column="4" FontAttributes="Bold" />
                    <Label Text="备注" Grid.Column="5" FontAttributes="Bold" />
                    <Label Text="操作" Grid.Column="6" FontAttributes="Bold" />
                </Grid>

                <!-- 产出记录列表 -->
                <CollectionView x:Name="OutputView" ItemsSource="{Binding OutputRecords}" IsVisible="{Binding IsOutputVisible}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="40,60,40,60,80,60,60"
                  Padding="4"
                  RowSpacing="1"
                  ColumnSpacing="1"
                  BackgroundColor="White">
                                <Label Text="{Binding ., Converter={StaticResource IndexConverter}, ConverterParameter={x:Reference OutputView}}" />
                                <Label Grid.Column="1" Text="{Binding MaterialName}" />
                                <Label Grid.Column="2" Text="{Binding Unit}" />
                                <Label Grid.Column="3" Text="{Binding Qty, StringFormat='{0:G29}'}" />
                                <Label Grid.Column="4" 
                       Text="{Binding OperateTime, StringFormat='{0:yyyy-M-d H:mm}'}" />
                                <Label Grid.Column="5" Text="{Binding Memo}" />
                                <Label Grid.Column="6"
                       Text="删除" TextColor="Red">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteOutputCommand}"
                                              CommandParameter="{Binding .}" />
                                    </Label.GestureRecognizers>
                                </Label>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </VerticalStackLayout>
        </ScrollView>

    </Grid>
</ContentPage>
